name: Trigger on Issue

on:
  issues:
    types: [opened]

permissions:
  issues: read
  actions: write

jobs:
  parse_and_trigger:
    runs-on: ubuntu-latest
    # if: github.repository_owner == 'Loongson-Cloud-Community'
    steps:
      - name: Extract package name & version from issue title
        id: parse
        run: |
          title="${{ github.event.issue.title }}"
          echo "Issue title: $title"

          if [ -z $(echo $title | grep -Po '^\S+==\S+$') ]; then
            echo "Title format invalid. Expect: package==version"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          pkg="${title%%==*}"
          ver="${title##*==}"

          if [ -z "$pkg" ] || [ -z "$ver" ]; then
            echo "Invalid package or version"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "package=$pkg" >> $GITHUB_OUTPUT
          echo "version=$ver" >> $GITHUB_OUTPUT
          echo "valid=true" >> $GITHUB_OUTPUT

      - name: Checkout repo
        if: steps.parse.outputs.valid == 'true'
        uses: actions/checkout@v4

      - name: Check if workflow file exists
        id: check
        if: steps.parse.outputs.valid == 'true'
        run: |
          file=".github/workflows/${{ steps.parse.outputs.package }}.yaml"
          echo "Checking file: $file"

          if [ -f "$file" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "workflow_file=$file" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger target workflow
        if: |
          steps.parse.outputs.valid == 'true' &&
          steps.check.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "${{ steps.check.outputs.workflow_file }}",
              ref: "main",
              inputs: {
                version: "${{ steps.parse.outputs.version }}"
              }
            })

      - name: Log skip message
        if: |
          steps.parse.outputs.valid != 'true' ||
          steps.check.outputs.file_exists != 'true'
        run: echo "Skipping workflow dispatch due to invalid title or missing workflow."
